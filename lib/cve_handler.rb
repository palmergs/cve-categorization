class CveHandler

  def initialize
    @depth = 0
    @current_vulnerability = nil
    @current_url = nil
    @current_element = nil
    @current_attrs = nil
  end

  def on_element namespace, name, attrs = {}
    if name == 'Vulnerability'
      @current_vulnerability = Vulnerability.new
    elsif name == 'Reference'
      @current_url = Reference.new
    else
      @current_element = name
      @current_attrs = attrs
    end
  end

  def on_text text
    tmp = one_line(text)
    return unless tmp.present?

    case @current_element
    when 'URL'
      @current_url.url = tmp if @current_url
    when 'Description'
      @current_url.description = tmp if @current_url
    when 'Note'
      if @current_vulnerability
        if @current_attrs['Type'] == 'Description'
          @current_vulnerability.description = tmp
        elsif @current_attrs['Title'] == 'Published'
          @current_vulnerability.publish_date = tmp
        end
      end
    when 'CVE'

      # At this point we have enough enformation to save the CVE
      # (so we can enforce uniqueness contraint on the referenes)
      begin
        vuln = Vulnerability.find_by(cve: tmp)
        if vuln
          puts "Vulnerability already exists :: #{ tmp }"
          @current_vulnerability = vuln
        else
          @current_vulnerability.cve = tmp
          @current_vulnerability.save!
        end
      rescue ActiveRecord::RecordInvalid
        warn "Unable to save vulnerability :: #{ @current_vulnerability.errors.full_messages}"
        @current_vulnerability = nil
      end
    end
  end

  def after_element namespace, name
    if name == 'Vulnerability'
      if @current_vulnerability && @current_vulnerability.changed?

        # Strip out any references that happen to be invalid
        @current_vulnerability.references.each do |ref|
          unless ref.save
            puts "Unable to save reference :: #{ ref.errors.full_messages }"
            ref.destroy
          end
        end

        # Update vulnerability with any additional fields that have been aggregated
        if @vulnerability.save

          # the vulnerability changed so it's existing assessments if any are destroyed
          puts "Destroying associated assessments for #{ @vulnerability.cve }"
          @vulnerability.assessments.destroy_all
        else
          warn "Unable to update vulnerability :: #{ @current_vulnerability.errors.full_messages }"
        end

        @current_vulnerability = nil
      end
    elsif name == 'Reference'
      if @current_vulnerability
        if @current_url.url.present?
          @current_vulnerability.references << @current_url
        end
      end
      @current_url = nil
    end
    @current_element = nil
    @current_attrs = nil
  end

  def one_line text
    encoded = text.encode('UTF-8', invalid: :replace, undef: :replace, replace: '?')
    encoded.gsub(/[\n\r\t\s]+/m, ' ')
  end
end
