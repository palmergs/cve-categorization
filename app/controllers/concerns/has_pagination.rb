module Concerns
  module HasPagination
    extend ActiveSupport::Concern

    DEFAULT_PAGE_SIZE = 20
    MAX_PAGE_SIZE = 200

    def current_page
      [0, params[:p].to_i].max
    end

    def current_size
      min_size = [1, Array.wrap(params[:ids]).length].max
      size = [(params[:limit] || DEFAULT_PAGE_SIZE).to_i, MAX_PAGE_SIZE].min
      size > min_size ? size : min_size
    end

    def current_sort default_col = :id, default_dir = :desc

      # no sort options defined
      return "#{ default_col } #{ default_dir }" unless params[:o]

      # col is defined but not a valid column
      col = params[:o].to_s.downcase.to_sym
      dirs = available_cols[col]
      return "#{ default_col } #{ default_dir }" unless dirs
      
      # sort as requested by params if direction is given
      dir = params[:d].to_s.downcase.to_sym
      return "#{ col } #{ dir }" if dirs.index(dir)

      # sort by default option in the available cols array
      "#{ col } #{ dirs.first }"
    end

    # Override for the columns availale for model; 
    # default sort order should by the first array option
    def available_cols
      {
        id: [ :asc, :desc ],
        created_at: [ :asc, :desc ]
      }
    end
  end
end
