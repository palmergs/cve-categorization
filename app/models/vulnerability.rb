class Vulnerability < ApplicationRecord

  has_many :references, dependent: :destroy
  has_many :technology_vulnerabilities, dependent: :destroy

  validates :title, presence: true
  validates :cve, uniqueness: true, presence: true

  scope :by_ids, ->(ids) {
    if ids
      arr = Array(ids).map(&:to_i).compact
      if arr
        where(id: arr)
      else
        where('1=0')
      end
    end
  }

  scope :by_query, ->(q) {
    if q.present?
      normalized = q.gsub(/[%_]/, '')
      if normalized.length > 2
        where('vulnerabilities.description like ?', "%#{ normalized }%")
      else
        where('2=0')
      end
    end
  }

  scope :by_year, ->(y) {
    if y && y.to_i > 1990 && y.to_i <= Time.current.year
      where('vulnerabilities.cve like ?', "CVE-#{ y }-%")
    end
  }


end
