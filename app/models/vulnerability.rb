class Vulnerability < ApplicationRecord
  include Concerns::HasIds

  has_many :references, dependent: :destroy
  has_many :vulnerability_inspections, dependent: :destroy
  has_many :term_vulnerabilities, dependent: :destroy

  validates :cve, uniqueness: true, presence: true

  scope :by_query, ->(q) {
    if q.present?
      str = normalized_query(str)
      if str.length > 1
        where('vulnerabilities.description like ?', "%#{ str }%")
      else
        where('2=0')
      end
    end
  }

  scope :by_year, ->(y) {
    if y && y.to_i > 1990 && y.to_i <= Time.current.year
      where('vulnerabilities.cve like ?', "CVE-#{ y }-%")
    end
  }

  scope :has_inspections, -> {
    where('vulnerabilities.vulnerability_inspections_count > 0')
  }

  scope :has_terms, -> {
    where('vulnerabilities.term_vulnerabilities_count > 0')
  }


end
