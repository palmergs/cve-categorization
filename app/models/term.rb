class Term < ApplicationRecord
  include Concerns::HasIds

  belongs_to :technology

  has_many :term_assessments, dependent: :destroy
  has_many :assessments, through: :term_assessments
  has_many :vulnerabilities, through: :assessments

  validates :term, presence: true, uniqueness: { scope: :technology_id }
  validates :value, presence: true, numericality: { only_integer: true, greater_than: -4, less_than: 4 }

  scope :by_query, ->(q) {
    if q
      str = normalize_query(q)
      if str.present?
        where('terms.term like ?', "%#{ str }%")
      else
        where('7=6')
      end
    end
  }

  after_create do |term|
    Vulnerability.by_query(term.term).each do |v|
      ass = Assessment.find_or_create_by(technology_id: term.technology_id, vulnerability_id: v.id)
      ass.term_assessments.create(term_id: term.id, value: term.value)
    end
  end
end
