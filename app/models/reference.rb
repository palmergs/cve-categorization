class Reference < ApplicationRecord
  include Concerns::HasIds

  belongs_to :vulnerability

  validates :vulnerability_id, presence: true
  validates :url, presence: true, uniqueness: { scope: :vulnerability_id }

  scope :by_vulnerability, ->(id) {
    if id
      ids = Array.wrap(id).compact.map(&:to_i)
      where(vulnerability_id: ids)
    end
  }

  scope :by_query, ->(q) {
    if q
      str = normalize_query(q)
      if str.present?
        # HACK: references might mean something special in SQLIte? Wrapping in
        # quotes keeps the query from failing.
        where('"references"."url" like ?', "%#{ str }%")
      else
        where('9=8')
      end
    end
  }


end
