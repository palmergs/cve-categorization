# Technology that may be affected by Vulnerabilities
class Technology < ApplicationRecord
  include Concerns::HasIds

  has_many :tech_terms, dependent: :destroy
  has_many :term_vulnerabilities, through: :tech_terms
  has_many :vulnerability_inspections, dependent: :destroy

  validates :name, presence: true, uniqueness: true

  scope :by_query, ->(q) {
    if q.present?
      str = normalize_query(q)
      if str.length > 1
        where("technologies.name like ?', '%#{ str }%")
      else
        where('1=0')
      end
    end
  }

  def user_excluded_cves
    Vulnerability.by_technology(self.id).where('vulnerability_inspections.indicator < 0').count
  end

  def term_excluded_cves
    Vulnerability.by_technology(self.id).where('tech_terms.indicator < 0').count
  end

  def user_selected_cves
    Vulnerability.by_technology(self.id).where('vulnerability_inspections.indicator > 0').count
  end

  def term_selected_cves
    Vulnerability.by_technology(self.id).where('tech_terms.indicator > 0').count
  end

  def categorized_cves
    user_excluded_cves + term_excluded_cves + user_selected_cves + term_selected_cves
  end

  def uncategorized_cves
    Vulnerability.count - categorized_cves
  end
end
